<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Investor Management System</title>
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <!-- D3.js for Gantt chart -->
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <!-- Chart.js for Pie and Bar Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Data Labels Plugin (for pie chart) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  
  <style>
    body {
      background-color: #f8f9fa;
      font-family: "Roboto", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin-bottom: 80px;
    }
    /* Header */
    header {
      background-color: #343a40;
      color: #fff;
      padding: 20px 0;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 48px;
    }
    /* Footer */
    footer {
      background-color: #343a40;
      color: #fff;
      padding: 15px 0;
      position: fixed;
      width: 100%;
      bottom: 0;
      text-align: center;
    }
    .container {
      margin-top: 30px;
    }
    /* Uniform card styling for all sections */
    .card {
      margin-bottom: 30px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      background-color: #fff;
    }
    .card-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #ccc;
      text-align: center;
      font-weight: bold;
      font-size: 18px; /* uniform header font size */
      padding: 10px;
    }
    .card-body {
      padding: 20px;
    }
    /* Table styling */
    .table th {
      background-color: #343a40;
      color: white;
      text-align: center;
      vertical-align: middle;
    }
    .table td {
      text-align: center;
      vertical-align: middle;
    }
    .name-left {
      text-align: left !important;
    }
    .balance-right {
      text-align: right !important;
    }
    .total-row {
      font-weight: bold;
      background-color: #e9ecef;
    }
    .duration-col, .remaining-col {
      width: 7%;
    }
    /* Charts Section */
    .charts-section {
      margin: 50px 0;
    }
    .chart-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    .chart-box {
      flex: 1 1 300px;
      max-width: 600px;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 350px;
    }
    /* Gantt Chart Card */
    .gantt-section .card {
      margin-bottom: 0; /* Remove extra bottom margin for Gantt card if desired */
    }
    .gantt-title {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 18px;
    }
    .gantt-chart {
      width: 100%;
      height: auto;
      border: 1px solid #ccc;
      background-color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    /* Tooltip for Gantt */
    .tooltip {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.75);
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      pointer-events: none;
      font-size: 13px;
      color: #fff;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      opacity: 0;
      transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
      z-index: 10;
    }
    /* Legend for D3 */
    .legend {
      font-size: 12px;
      fill: #333;
    }
    .legend-label {
      dominant-baseline: middle;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="mb-4">
    <h1>Investor Management System</h1>
  </header>

  <!-- Main Content -->
  <div class="container">
    <!-- Sync controls / status -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <strong>Last synced:</strong>
        {% if last_update_time %}
          {{ last_update_time.strftime('%Y-%m-%d %H:%M:%S') }} UTC
        {% else %}
          Never
        {% endif %}
      </div>
      <div>
        <a href="{{ url_for('sync') }}" class="btn btn-primary btn-sm">
          Sync Now
        </a>
      </div>
    </div>

    <!-- Investor Details Table Card -->
    <div class="card">
      <div class="card-header">
        Investor Details
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead>
              <tr>
                <th>Investor Name</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th class="duration-col">Duration (Months)</th>
                <th class="remaining-col">Remaining (Months)</th>
                <th>Profit %</th>
                <th class="balance-right">Monthly Profit</th>
                <th class="balance-right">Balance Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for investor in investors %}
              <tr>
                <td class="name-left">{{ investor.name }}</td>
                <td>{{ investor.start_date if investor.start_date else '-' }}</td>
                <td>{{ investor.end_date if investor.end_date else '-' }}</td>
                <td>{{ investor.duration_months if investor.duration_months is not none else '-' }}</td>
                <td>{{ investor.remaining_months if investor.remaining_months is not none else '-' }}</td>
                <td>{{ investor.profit_percentage }}</td>
                <td class="balance-right">{{ format_currency(investor.monthly_profit) }}</td>
                <td class="balance-right">{{ format_currency(investor.balance) }}</td>
              </tr>
              {% endfor %}
              <tr class="total-row">
                <td colspan="6" class="text-end">Totals</td>
                <td class="balance-right">{{ format_currency(total_monthly_profit) }}</td>
                <td class="balance-right">{{ format_currency(total_balance) }}</td>
              </tr>
              <tr class="total-row">
                <td colspan="6" class="text-end">Profit % (Formula):</td>
                <td colspan="2">{{ computed_profit_percentage | round(2) }}%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Profit Payable Table Card -->
    <div class="card">
      <div class="card-header">
        Profit Payable Status
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead>
              <tr>
                <th>Investor Name</th>
                <th class="balance-right">Profit Payable (Up to Now)</th>
                <th class="balance-right">Profit Paid</th>
                <th class="balance-right">Current Payable</th>
              </tr>
            </thead>
            <tbody>
              {% for investor in investors %}
              <tr>
                <td class="name-left">{{ investor.name }}</td>
                <td class="balance-right">{{ format_currency(investor.profit_payable_up_to_now) }}</td>
                <td class="balance-right">{{ format_currency(investor.dividend_paid) }}</td>
                <td class="balance-right">{{ format_currency(investor.profit_due) }}</td>
              </tr>
              {% endfor %}
              <tr class="total-row">
                <td>Total</td>
                <td class="balance-right">{{ format_currency(total_profit_payable_up_to_now) }}</td>
                <td class="balance-right">{{ format_currency(total_dividend_paid) }}</td>
                <td class="balance-right">{{ format_currency(total_current_payable) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Charts Section: Pie and Bar Charts Cards -->
    <div class="charts-section">
      <!-- Pie Chart Card -->
      <div class="card chart-card">
        <div class="card-header">
          Investor's Investment Ratio (Pie Chart)
        </div>
        <div class="card-body">
          <canvas id="investmentPieChart"></canvas>
        </div>
      </div>
      <!-- Bar Chart Card -->
      <div class="card chart-card">
        <div class="card-header">
          Investor's Investment Distribution (Bar Chart)
        </div>
        <div class="card-body">
          <canvas id="investmentBarChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Gantt Chart Section Card -->
    <div class="card">
      <div class="card-header">
        Investor Timeline (Bar Height Reflects Invested Amount)
      </div>
      <div class="card-body">
        <svg class="gantt-chart" viewBox="0 0 1200 500" preserveAspectRatio="xMinYMin meet"></svg>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container">
      <p class="mb-0">&copy; 2025 Investor Management System. All rights reserved.</p>
    </div>
  </footer>

  <!-- Tooltip (for Gantt) -->
  <div class="tooltip" id="tooltip"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Pie & Bar Charts Script (Using Data Labels for the Pie) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script>
    fetch('/chart_data')
      .then(response => response.json())
      .then(data => {
        // Save real investor names for tooltip display
        const realLabels = data.labels;
        // Use blank labels for the pie chart slices so only percentages are shown
        const blankLabels = data.balances.map(() => "");

        // PIE CHART: Only show percentage on slices; tooltip includes investor name
        const pieCtx = document.getElementById('investmentPieChart').getContext('2d');
        new Chart(pieCtx, {
          type: 'pie',
          data: {
            labels: blankLabels,
            datasets: [{
              data: data.balances,
              backgroundColor: [
                'rgba(75, 192, 192, 0.6)',
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)'
              ],
              borderColor: [
                'rgba(75, 192, 192, 1)',
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: true, text: "Investor's Investment Ratio" },
              tooltip: {
                callbacks: {
                  // Tooltip shows investor name, $value and percentage
                  label: function(context) {
                    const i = context.dataIndex;
                    const name = realLabels[i] || '';
                    const value = context.parsed || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = (value / total * 100).toFixed(2) + '%';
                    return `${name}: $${value.toLocaleString()} (${percentage})`;
                  }
                }
              },
              datalabels: {
                formatter: function(value, ctx) {
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = (value / total * 100).toFixed(1) + '%';
                  return percentage;
                },
                color: '#fff',
                font: {
                  size: 12,
                  weight: 'bold'
                }
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        // BAR CHART - horizontal bar chart
        const barCtx = document.getElementById('investmentBarChart').getContext('2d');
        new Chart(barCtx, {
          type: 'bar',
          data: {
            labels: data.labels, // use real investor names for bar chart
            datasets: [{
              label: 'Balance Amount',
              data: data.balances,
              backgroundColor: 'rgba(54, 162, 235, 0.6)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: true, text: "Investor's Investment Distribution" },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.parsed.x;
                    return 'Balance Amount: $' + value.toLocaleString();
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: {
                  callback: value => '$' + value.toLocaleString()
                }
              }
            }
          }
        });
      })
      .catch(error => console.error('Error fetching chart data:', error));
  </script>

  <!-- Gantt Chart Script (Unified Design) -->
  <script>
    const svgWidth = 1200;
    const svgHeight = 500;
    const margin = { top: 30, right: 30, bottom: 60, left: 200 },
          width = svgWidth - margin.left - margin.right,
          height = svgHeight - margin.top - margin.bottom;

    const svg = d3.select("svg.gantt-chart");
    const g = svg.append("g")
                 .attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleTime().range([0, width]);
    const y = d3.scaleBand().range([0, height]).padding(0.3);
    const barHeightScale = d3.scaleLinear().range([10, 50]);
    const colorScale = d3.scaleSequential().interpolator(d3.interpolateViridis);

    const tooltip = d3.select("#tooltip");
    const legendWidth = 150;
    const legendHeight = 10;

    d3.json("/gantt_data").then(data => {
      data.rows.forEach(d => {
        d.start = new Date(d.start_date);
        d.end = new Date(d.end_date);
        d.invested_amount = +d.invested_amount;
      });

      data.rows.sort((a, b) => a.start - b.start);

      let minDate = d3.min(data.rows, d => d.start);
      let maxDate = d3.max(data.rows, d => d.end);
      let rangeMs = maxDate - minDate;
      const domainPadding = 0.15;
      let leftPad = new Date(minDate.getTime() - rangeMs * domainPadding);
      let rightPad = new Date(maxDate.getTime() + rangeMs * domainPadding);
      x.domain([leftPad, rightPad]);

      y.domain(data.rows.map(d => d.investor));
      const investedExtent = d3.extent(data.rows, d => d.invested_amount);
      barHeightScale.domain(investedExtent);
      colorScale.domain(investedExtent);

      g.append("g")
        .attr("class", "grid")
        .call(
          d3.axisBottom(x)
            .ticks(d3.timeMonth.every(2))
            .tickSize(height)
            .tickFormat(() => "")
        )
        .style("stroke-dasharray", "1,4")
        .style("stroke", "#ddd");

      const xAxis = g.append("g")
        .attr("class", "axis axis--x")
        .attr("transform", `translate(0, ${height})`)
        .call(
          d3.axisBottom(x)
            .ticks(d3.timeMonth.every(2))
            .tickFormat(d3.timeFormat("%b %Y"))
            .tickSizeOuter(0)
        );

      xAxis.selectAll("text")
        .attr("text-anchor", "end")
        .attr("transform", "rotate(-45)")
        .attr("dx", "-0.8em")
        .attr("dy", "0.15em");

      xAxis.append("text")
        .attr("class", "axis-label")
        .attr("x", width / 2)
        .attr("y", 70)
        .attr("fill", "#333")
        .attr("text-anchor", "middle")
        .style("font-size", "14px")
        .text("Month & Year");

      g.selectAll(".bar")
        .data(data.rows)
        .enter().append("rect")
          .attr("class", "bar")
          .attr("rx", 4)
          .attr("ry", 4)
          .attr("x", d => x(d.start))
          .attr("y", d => {
            const bandPos = y(d.investor);
            const bandHeight = y.bandwidth();
            const barH = barHeightScale(d.invested_amount);
            return bandPos + (bandHeight - barH) / 2;
          })
          .attr("width", d => x(d.end) - x(d.start))
          .attr("height", d => barHeightScale(d.invested_amount))
          .attr("fill", d => colorScale(d.invested_amount))
          .style("cursor", "pointer")
          .on("mouseover", function(event, d) {
            d3.select(this)
              .transition()
              .duration(200)
              .attr("transform", "scale(1.03)");
            tooltip.transition().style("opacity", 0.95)
                   .style("transform", "translateY(-5px)");
            tooltip.html(`<strong>${d.investor}</strong><br/>
                          Invested: $${d.invested_amount.toLocaleString()}<br/>
                          Start: ${d.start.toLocaleDateString()}<br/>
                          End: ${d.end.toLocaleDateString()}`)
                   .style("left", (event.pageX + 10) + "px")
                   .style("top", (event.pageY - 28) + "px");
          })
          .on("mousemove", function(event) {
            tooltip.style("left", (event.pageX + 10) + "px")
                   .style("top", (event.pageY - 28) + "px");
          })
          .on("mouseout", function() {
            d3.select(this)
              .transition()
              .duration(200)
              .attr("transform", "scale(1)");
            tooltip.transition().style("opacity", 0);
          });

      g.selectAll(".bar-label")
        .data(data.rows)
        .enter().append("text")
          .attr("class", "bar-label")
          .attr("x", d => {
            const barStart = x(d.start);
            const barEnd = x(d.end);
            return barStart + (barEnd - barStart) / 2;
          })
          .attr("y", d => {
            const bandPos = y(d.investor);
            return bandPos + (y.bandwidth() / 2);
          })
          .attr("dy", "0.35em")
          .attr("text-anchor", "middle")
          .style("font-size", "12px")
          .style("fill", "#fff")
          .text(d => `$${d.invested_amount.toLocaleString()}`);

      g.selectAll(".label")
        .data(data.rows)
        .enter().append("text")
          .attr("class", "label")
          .attr("x", -10)
          .attr("y", d => y(d.investor) + y.bandwidth() / 2)
          .attr("dy", ".35em")
          .attr("text-anchor", "end")
          .style("font-size", "12px")
          .style("fill", "#333")
          .text(d => d.investor);

      const legendGroup = svg.append("g")
        .attr("transform", `translate(${margin.left + width - legendWidth}, ${margin.top})`);

      const defs = svg.append("defs");
      const linearGradient = defs.append("linearGradient")
        .attr("id", "legend-gradient");
      
      linearGradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", colorScale(colorScale.domain()[0]));
      
      linearGradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", colorScale(colorScale.domain()[1]));

      legendGroup.append("rect")
        .attr("width", legendWidth)
        .attr("height", legendHeight)
        .style("fill", "url(#legend-gradient)")
        .style("stroke", "#ccc")
        .style("stroke-width", 1);

      legendGroup.append("text")
        .attr("x", 0)
        .attr("y", legendHeight + 14)
        .attr("fill", "#333")
        .attr("font-size", "12px")
        .text(`$${Math.round(colorScale.domain()[0]).toLocaleString()}`);

      legendGroup.append("text")
        .attr("x", legendWidth)
        .attr("y", legendHeight + 14)
        .attr("text-anchor", "end")
        .attr("fill", "#333")
        .attr("font-size", "12px")
        .text(`$${Math.round(colorScale.domain()[1]).toLocaleString()}`);

      legendGroup.append("text")
        .attr("x", 0)
        .attr("y", -5)
        .attr("fill", "#333")
        .attr("font-size", "12px")
        .text("Invested Amount");
    })
    .catch(error => {
      console.error("Error fetching gantt data:", error);
    });
  </script>
</body>
</html>
