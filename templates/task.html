<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Investor Management System</title>
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <!-- D3.js for Gantt chart -->
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <!-- Plotly for modern charts -->
  <script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>
  
  <style>
    body {
      background-color: #ffffff;
      color: #111827;
      font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding-bottom: 60px;
    }
    /* Header / Nav */
    header {
      background-color: #f1f5f9;
      color: #111827;
      padding: 16px 0;
      text-align: center;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.08);
    }
    header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
    }
    .top-nav {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 10px;
    }
    .top-nav .nav-link-pill {
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #6b7280;
      text-decoration: none;
      padding: 6px 18px;
      border-radius: 999px;
      transition: all 0.15s ease-in-out;
    }
    .top-nav .nav-link-pill:hover {
      background-color: #e5e7eb;
      color: #111827;
    }
    .top-nav .nav-link-pill.active {
      background-color: #111827;
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.25);
    }
    /* Footer */
    footer {
      background-color: #f1f5f9;
      color: #6b7280;
      text-align: center;
      padding: 10px 0;
      position: fixed;
      bottom: 0;
      width: 100%;
      font-size: 12px;
    }
    .container {
      margin-top: 30px;
      max-width: 1200px;
    }
    /* Uniform card styling for all sections */
    .card {
      margin-bottom: 30px;
      border: none;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
      background-color: #ffffff;
      color: #111827;
    }
    .card-header {
      background-color: #f3f4f6;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
      font-weight: bold;
      font-size: 18px; /* uniform header font size */
      padding: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .card-body {
      padding: 20px;
    }
    /* Table styling */
    .table th {
      background-color: #e5e7eb;
      color: #111827;
      text-align: center;
      vertical-align: middle;
    }
    .table td {
      text-align: center;
      vertical-align: middle;
    }
    .table tbody tr:nth-child(odd) {
      background-color: #f9fafb;
    }
    .table tbody tr:nth-child(even) {
      background-color: #ffffff;
    }
    .table tbody tr.total-row {
      background-color: #e5e7eb !important;
    }
    .name-left {
      text-align: left !important;
    }
    .balance-right {
      text-align: right !important;
    }
    .total-row {
      font-weight: bold;
      background-color: #e9ecef;
    }
    .duration-col, .remaining-col {
      width: 7%;
    }
    /* Charts Section */
    .charts-section {
      margin: 50px 0 10px 0;
    }
    .chart-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    .chart-box {
      flex: 1 1 300px;
      max-width: 600px;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 350px;
    }
    /* Gantt Chart Card */
    .gantt-section .card {
      margin-bottom: 0; /* Remove extra bottom margin for Gantt card if desired */
    }
    .gantt-title {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 18px;
    }
    .gantt-chart {
      width: 100%;
      height: auto;
      border: 1px solid #ccc;
      background-color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    /* Tooltip for Gantt */
    .tooltip {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.75);
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      pointer-events: none;
      font-size: 13px;
      color: #fff;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      opacity: 0;
      transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
      z-index: 10;
    }
    /* Legend for D3 */
    .legend {
      font-size: 12px;
      fill: #333;
    }
    .legend-label {
      dominant-baseline: middle;
    }
    /* Light cards for charts for better readability */
    .card.chart-card {
      background-color: #ffffff;
      color: #111827;
    }
    .card.chart-card .card-header {
      background-color: #f3f4f6;
      color: #111827;
      border-bottom: 1px solid #e5e7eb;
    }
  </style>
</head>
<body>
  <!-- Header + Nav -->
  <header class="mb-4">
    <h1>Investor Management System</h1>
    <nav class="top-nav">
      <a class="nav-link-pill {% if request.endpoint == 'home' %}active{% endif %}" href="{{ url_for('home') }}">Dashboard</a>
      <a class="nav-link-pill {% if request.endpoint == 'investment_summary' %}active{% endif %}" href="{{ url_for('investment_summary') }}">Investment Summary</a>
      <a class="nav-link-pill {% if request.endpoint == 'change_password' %}active{% endif %}" href="{{ url_for('change_password') }}">Change Password</a>
      <a class="nav-link-pill" href="{{ url_for('logout') }}">Logout</a>
    </nav>
  </header>

  <!-- Main Content -->
  <div class="container">
    <!-- Sync controls / status -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <div>
        <strong>Last synced:</strong>
        {% if last_update_time %}
          {{ last_update_time.strftime('%Y-%m-%d %H:%M:%S') }} UTC
        {% else %}
          Never
        {% endif %}
      </div>
      <div class="d-flex align-items-center gap-2">
        <form method="get" class="d-flex align-items-center gap-1">
          <input
            type="text"
            name="q"
            class="form-control form-control-sm"
            placeholder="Search investor name..."
            value="{{ search_query or request.args.get('q', '') }}"
          >
          <button type="submit" class="btn btn-outline-secondary btn-sm">Search</button>
          {% if search_query or request.args.get('q') %}
            <a href="{{ url_for('home') }}" class="btn btn-link btn-sm text-decoration-none">Clear</a>
          {% endif %}
        </form>
        <a href="{{ url_for('sync') }}" class="btn btn-primary btn-sm">
          Sync Now
        </a>
      </div>
    </div>

    <!-- Investor Details Table Card -->
    <div class="card">
      <div class="card-header">
        Investor Details
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead>
              <tr>
                <th>Investor Name</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th class="duration-col">Duration (Months)</th>
                <th class="remaining-col">Remaining (Months)</th>
                <th>Profit %</th>
                <th class="balance-right">Monthly Profit (Tk)</th>
                <th class="balance-right">Balance Amount (Tk)</th>
              </tr>
            </thead>
            <tbody>
              {% for investor in investors %}
              <tr class="{% if investor.kind == 'total' %}total-row{% endif %}">
                <td class="name-left">
                  {% if investor.kind == 'total' %}
                    {{ investor.name }}
                  {% else %}
                    &mdash; {{ investor.name }}
                  {% endif %}
                </td>
                <td>{{ investor.start_date if investor.start_date else '-' }}</td>
                <td>{{ investor.end_date if investor.end_date else '-' }}</td>
                <td>
                  {% if investor.start_date and investor.end_date and investor.duration_months is not none %}
                    {{ investor.duration_months }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if investor.start_date and investor.end_date and investor.remaining_months is not none %}
                    {{ investor.remaining_months }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if investor.start_date and investor.profit_percentage %}
                    {{ investor.profit_percentage }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="balance-right">
                  {% if investor.start_date and investor.profit_percentage %}
                    {{ format_currency(investor.monthly_profit) }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="balance-right">{{ format_currency(investor.balance) }}</td>
              </tr>
              {% endfor %}
              <tr class="total-row">
                <td colspan="6" class="text-end">Totals</td>
                <td class="balance-right">{{ format_currency(total_monthly_profit) }}</td>
                <td class="balance-right">{{ format_currency(total_balance) }}</td>
              </tr>
              <tr class="total-row">
                <td colspan="6" class="text-end">Profit % (Formula):</td>
                <td colspan="2">{{ computed_profit_percentage | round(2) }}%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Charts Section: Pie and Bar Charts Cards -->
    <div class="charts-section">
      <!-- Pie Chart Card -->
      <div class="card chart-card">
        <div class="card-header">
          Investor's Investment Ratio (Pie Chart)
        </div>
        <div class="card-body">
          <div id="investmentPieChart" style="height:380px;"></div>
        </div>
      </div>
      <!-- Bar Chart Card -->
      <div class="card chart-card">
        <div class="card-header">
          Investor's Investment Distribution (Bar Chart)
        </div>
        <div class="card-body">
          <div id="investmentBarChart" style="height:380px;"></div>
        </div>
      </div>
    </div>

    <!-- Gantt Chart Section Card -->
    <div class="card">
      <div class="card-header">
        Investor Timeline (Bar Height Reflects Invested Amount)
      </div>
      <div class="card-body">
        <svg class="gantt-chart" viewBox="0 0 1200 500" preserveAspectRatio="xMinYMin meet"></svg>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container">
      <p class="mb-0">&copy; Investor Management System. All rights reserved.</p>
    </div>
  </footer>

  <!-- Tooltip (for Gantt) -->
  <div class="tooltip" id="tooltip"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Pie & Bar Charts Script -->
  <script>
    // Carry current ?q= filter through to chart_data so charts
    // reflect the same investor-name filter as the table.
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q') || '';
    let chartUrl = '/chart_data';
    if (query) {
      chartUrl += '?q=' + encodeURIComponent(query);
    }

    fetch(chartUrl)
      .then(response => response.json())
      .then(data => {
        // Build pairs of {name, value}
        const pairs = (data.labels || []).map((name, i) => ({
          name: name || 'Unknown',
          value: Number((data.balances || [])[i] || 0)
        }));

        const total = pairs.reduce((sum, p) => sum + p.value, 0);
        const maxSlices = 8; // show top 8 investors, group rest as "Others"

        // Sort descending by value
        pairs.sort((a, b) => b.value - a.value);

        const main = pairs.slice(0, maxSlices);
        const others = pairs.slice(maxSlices);
        if (others.length > 0) {
          const othersTotal = others.reduce((sum, p) => sum + p.value, 0);
          if (othersTotal > 0) {
            main.push({ name: 'Others', value: othersTotal });
          }
        }

        const pieLabels = main.map(p => p.name);
        const pieData = main.map(p => p.value);

        // PIE / DONUT CHART USING PLOTLY
        const pieDiv = document.getElementById('investmentPieChart');
        const pieTrace = {
          labels: pieLabels,
          values: pieData,
          type: 'pie',
          hole: 0.45,
          textinfo: 'percent',
          textposition: 'inside',
          hovertemplate: '%{label}<br>Tk %{value:,.0f} (%{percent})<extra></extra>',
          marker: {
            colors: [
              'rgba(59, 130, 246, 0.85)',
              'rgba(16, 185, 129, 0.85)',
              'rgba(245, 158, 11, 0.85)',
              'rgba(239, 68, 68, 0.85)',
              'rgba(139, 92, 246, 0.85)',
              'rgba(236, 72, 153, 0.85)',
              'rgba(34, 197, 94, 0.85)',
              'rgba(148, 163, 184, 0.85)'
            ],
            line: { color: '#ffffff', width: 1 }
          }
        };

        const pieLayout = {
          margin: { l: 10, r: 10, t: 30, b: 10 },
          showlegend: true,
          legend: { orientation: 'v', x: 1.02, y: 0.5 },
          title: { text: "Investor's Investment Ratio", font: { size: 16 } }
        };

        Plotly.newPlot(pieDiv, [pieTrace], pieLayout, { responsive: true });
      })
      .catch(error => console.error('Error fetching chart data:', error));

    // Bar chart rendered from Python-generated Plotly figure
    const barDiv = document.getElementById('investmentBarChart');
    const barFig = {{ bar_chart_json | safe }};
    Plotly.newPlot(barDiv, barFig.data, barFig.layout, { responsive: true });
  </script>

  <!-- Gantt Chart Script (Unified Design) -->
  <script>
    const svgWidth = 1200;
    const svgHeight = 500;
    const margin = { top: 30, right: 30, bottom: 60, left: 200 },
          width = svgWidth - margin.left - margin.right,
          height = svgHeight - margin.top - margin.bottom;

    const svg = d3.select("svg.gantt-chart");
    const g = svg.append("g")
                 .attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleTime().range([0, width]);
    const y = d3.scaleBand().range([0, height]).padding(0.3);
    const barHeightScale = d3.scaleLinear().range([10, 50]);
    const colorScale = d3.scaleSequential().interpolator(d3.interpolateViridis);

    const tooltip = d3.select("#tooltip");
    const legendWidth = 150;
    const legendHeight = 10;

    d3.json("/gantt_data").then(data => {
      data.rows.forEach(d => {
        d.start = new Date(d.start_date);
        d.end = new Date(d.end_date);
        d.invested_amount = +d.invested_amount;
      });

      data.rows.sort((a, b) => a.start - b.start);

      let minDate = d3.min(data.rows, d => d.start);
      let maxDate = d3.max(data.rows, d => d.end);
      let rangeMs = maxDate - minDate;
      const domainPadding = 0.15;
      let leftPad = new Date(minDate.getTime() - rangeMs * domainPadding);
      let rightPad = new Date(maxDate.getTime() + rangeMs * domainPadding);
      x.domain([leftPad, rightPad]);

      y.domain(data.rows.map(d => d.investor));
      const investedExtent = d3.extent(data.rows, d => d.invested_amount);
      barHeightScale.domain(investedExtent);
      colorScale.domain(investedExtent);

      g.append("g")
        .attr("class", "grid")
        .call(
          d3.axisBottom(x)
            .ticks(d3.timeMonth.every(2))
            .tickSize(height)
            .tickFormat(() => "")
        )
        .style("stroke-dasharray", "1,4")
        .style("stroke", "#ddd");

      const xAxis = g.append("g")
        .attr("class", "axis axis--x")
        .attr("transform", `translate(0, ${height})`)
        .call(
          d3.axisBottom(x)
            .ticks(d3.timeMonth.every(2))
            .tickFormat(d3.timeFormat("%b %Y"))
            .tickSizeOuter(0)
        );

      xAxis.selectAll("text")
        .attr("text-anchor", "end")
        .attr("transform", "rotate(-45)")
        .attr("dx", "-0.8em")
        .attr("dy", "0.15em");

      xAxis.append("text")
        .attr("class", "axis-label")
        .attr("x", width / 2)
        .attr("y", 70)
        .attr("fill", "#333")
        .attr("text-anchor", "middle")
        .style("font-size", "14px")
        .text("Month & Year");

      g.selectAll(".bar")
        .data(data.rows)
        .enter().append("rect")
          .attr("class", "bar")
          .attr("rx", 4)
          .attr("ry", 4)
          .attr("x", d => x(d.start))
          .attr("y", d => {
            const bandPos = y(d.investor);
            const bandHeight = y.bandwidth();
            const barH = barHeightScale(d.invested_amount);
            return bandPos + (bandHeight - barH) / 2;
          })
          .attr("width", d => x(d.end) - x(d.start))
          .attr("height", d => barHeightScale(d.invested_amount))
          .attr("fill", d => colorScale(d.invested_amount))
          .style("cursor", "pointer")
          .on("mouseover", function(event, d) {
            d3.select(this)
              .transition()
              .duration(200)
              .attr("transform", "scale(1.03)");
            tooltip.transition().style("opacity", 0.95)
                   .style("transform", "translateY(-5px)");
            tooltip.html(`<strong>${d.investor}</strong><br/>
                          Invested: Tk ${d.invested_amount.toLocaleString()}<br/>
                          Start: ${d.start.toLocaleDateString()}<br/>
                          End: ${d.end.toLocaleDateString()}`)
                   .style("left", (event.pageX + 10) + "px")
                   .style("top", (event.pageY - 28) + "px");
          })
          .on("mousemove", function(event) {
            tooltip.style("left", (event.pageX + 10) + "px")
                   .style("top", (event.pageY - 28) + "px");
          })
          .on("mouseout", function() {
            d3.select(this)
              .transition()
              .duration(200)
              .attr("transform", "scale(1)");
            tooltip.transition().style("opacity", 0);
          });

      g.selectAll(".bar-label")
        .data(data.rows)
        .enter().append("text")
          .attr("class", "bar-label")
          .attr("x", d => {
            const barStart = x(d.start);
            const barEnd = x(d.end);
            return barStart + (barEnd - barStart) / 2;
          })
          .attr("y", d => {
            const bandPos = y(d.investor);
            return bandPos + (y.bandwidth() / 2);
          })
          .attr("dy", "0.35em")
          .attr("text-anchor", "middle")
          .style("font-size", "12px")
          .style("fill", "#fff")
          .text(d => `Tk ${d.invested_amount.toLocaleString()}`);

      g.selectAll(".label")
        .data(data.rows)
        .enter().append("text")
          .attr("class", "label")
          .attr("x", -10)
          .attr("y", d => y(d.investor) + y.bandwidth() / 2)
          .attr("dy", ".35em")
          .attr("text-anchor", "end")
          .style("font-size", "12px")
          .style("fill", "#333")
          .text(d => d.investor);

      const legendGroup = svg.append("g")
        .attr("transform", `translate(${margin.left + width - legendWidth}, ${margin.top})`);

      const defs = svg.append("defs");
      const linearGradient = defs.append("linearGradient")
        .attr("id", "legend-gradient");
      
      linearGradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", colorScale(colorScale.domain()[0]));
      
      linearGradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", colorScale(colorScale.domain()[1]));

      legendGroup.append("rect")
        .attr("width", legendWidth)
        .attr("height", legendHeight)
        .style("fill", "url(#legend-gradient)")
        .style("stroke", "#ccc")
        .style("stroke-width", 1);

      legendGroup.append("text")
        .attr("x", 0)
        .attr("y", legendHeight + 14)
        .attr("fill", "#333")
        .attr("font-size", "12px")
        .text(`Tk ${Math.round(colorScale.domain()[0]).toLocaleString()}`);

      legendGroup.append("text")
        .attr("x", legendWidth)
        .attr("y", legendHeight + 14)
        .attr("text-anchor", "end")
        .attr("fill", "#333")
        .attr("font-size", "12px")
        .text(`Tk ${Math.round(colorScale.domain()[1]).toLocaleString()}`);

      legendGroup.append("text")
        .attr("x", 0)
        .attr("y", -5)
        .attr("fill", "#333")
        .attr("font-size", "12px")
        .text("Invested Amount");
    })
    .catch(error => {
      console.error("Error fetching gantt data:", error);
    });
  </script>
</body>
</html>
